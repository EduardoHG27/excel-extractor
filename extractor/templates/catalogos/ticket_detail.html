<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket {{ ticket.codigo }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .codigo-box {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 2rem;
            border-left: 8px solid;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .codigo-ticket {
            font-family: monospace;
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 2px;
        }
        .estado-badge {
            font-size: 1.2rem;
            padding: 0.75rem 2rem;
            border-radius: 50px;
        }
        .info-card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.03);
            transition: all 0.2s;
            height: 100%;
        }
        .info-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .parte-codigo {
            display: inline-block;
            padding: 0.5rem 1.2rem;
            background: white;
            border-radius: 30px;
            margin: 0.25rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            border: 1px solid #dee2e6;
            font-size: 1rem;
        }
        .parte-titulo {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #6c757d;
            letter-spacing: 1px;
        }
        .parte-valor {
            font-weight: 700;
            font-size: 1.1rem;
        }
        .table-detail td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #f1f3f5;
        }
        .table-detail tr:last-child td {
            border-bottom: none;
        }
        .table-detail th {
            width: 160px;
            color: #495057;
            font-weight: 600;
            background-color: #f8f9fa;
            padding: 0.75rem 1rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Encabezado -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'upload_excel' %}">Inicio</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'ticket_list' %}">Tickets</a></li>
                        <li class="breadcrumb-item active">Detalle del Ticket</li>
                    </ol>
                </nav>
                <h1 class="display-6">
                    <i class="bi bi-ticket-detailed text-primary"></i> Detalle del Ticket
                </h1>
            </div>
            <div>
                <a href="{% url 'ticket_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver al listado
                </a>
            </div>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    <i class="bi bi-info-circle"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Código del ticket y estado -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="codigo-box border-{% if ticket.estado == 'GENERADO' %}info
                                                  {% elif ticket.estado == 'EN_PROCESO' %}warning
                                                  {% elif ticket.estado == 'COMPLETADO' %}success
                                                  {% else %}danger{% endif %}">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <small class="text-muted text-uppercase fw-bold">Código de Ticket</small>
                            <div class="codigo-ticket">
                                {{ ticket.codigo }}
                            </div>
                            <div class="mt-2">
                                <span class="badge bg-light text-dark me-2">
                                    <i class="bi bi-calendar3"></i> Creado: {{ ticket.fecha_creacion|date:"d/m/Y H:i" }}
                                </span>
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-arrow-repeat"></i> Actualizado: {{ ticket.fecha_actualizacion|date:"d/m/Y H:i" }}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end mt-3 mt-md-0">
                            <span class="badge estado-badge bg-{% if ticket.estado == 'GENERADO' %}info
                                                             {% elif ticket.estado == 'EN_PROCESO' %}warning
                                                             {% elif ticket.estado == 'COMPLETADO' %}success
                                                             {% else %}danger{% endif %}">
                                {{ ticket.get_estado_display }}
                            </span>
                        </div>
                          <div class="card-body">
                            <div class="btn-group">
                                <a href="{% url 'generar_dictamen' ticket.id %}" class="btn btn-success">
                                    <i class="bi bi-file-excel"></i> Descargar Dictamen
                                </a>
                                <a href="{% url 'generar_resultados' ticket.id %}" class="btn btn-warning">
                                    <i class="bi bi-file-excel"></i> Descargar Resultados
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Componentes del código -->
        <div class="card info-card mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0">
                    <i class="bi bi-upc-scan text-primary"></i> Componentes del Ticket
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        {% with partes=ticket.get_detalle_partes %}
                            <span class="parte-codigo">
                                <span class="parte-titulo d-block">Empresa</span>
                                <span class="parte-valor">{{ partes.empresa }}</span>
                            </span>
                            <span class="parte-codigo">
                                <span class="parte-titulo d-block">Tipo Servicio</span>
                                <span class="parte-valor">{{ partes.tipo_servicio }}</span>
                            </span>
                            <span class="parte-codigo">
                                <span class="parte-titulo d-block">Tipo de pruebas</span>
                                <span class="parte-valor">{{ partes.funcion }}</span>
                            </span>
                            <span class="parte-codigo">
                                <span class="parte-titulo d-block">No. Pruebas</span>
                                <span class="parte-valor">{{ partes.version }}</span>
                            </span>
                            <span class="parte-codigo">
                                <span class="parte-titulo d-block">Cliente</span>
                                <span class="parte-valor">{{ partes.cliente }}</span>
                            </span>
                            <span class="parte-codigo">
                                <span class="parte-titulo d-block">Proyecto</span>
                                <span class="parte-valor">{{ partes.proyecto }}</span>
                            </span>
                            <span class="parte-codigo">
                                <span class="parte-titulo d-block">Consecutivo</span>
                                <span class="parte-valor">{{ partes.consecutivo }}</span>
                            </span>
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Cliente y Proyecto -->
            <div class="col-md-6 mb-4">
                <div class="card info-card">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">
                            <i class="bi bi-building text-primary"></i> Cliente y Proyecto
                        </h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-detail mb-0">
                            <tr>
                                <th>Cliente:</th>
                                <td>
                                    {% if ticket.cliente %}
                                        <strong>{{ ticket.cliente.nombre }}</strong>
                                        <span class="badge bg-secondary ms-2">{{ ticket.cliente.nomenclatura }}</span>
                                    {% else %}
                                        <span class="text-muted">No asignado ({{ ticket.cliente_code }})</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Proyecto:</th>
                                <td>
                                    {% if ticket.proyecto %}
                                        <strong>{{ ticket.proyecto.nombre }}</strong>
                                        <span class="badge bg-secondary ms-2">{{ ticket.proyecto.codigo }}</span>
                                    {% else %}
                                        <span class="text-muted">No asignado ({{ ticket.proyecto_code }})</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Tipo de pruebas:</th>
                                <td>
                                    {% if ticket.tipo_servicio %}
                                        <strong>{{ ticket.tipo_servicio.nombre }}</strong>
                                        <span class="badge bg-secondary ms-2">{{ ticket.tipo_servicio.nomenclatura }}</span>
                                    {% else %}
                                        <span class="text-muted">{{ ticket.tipo_servicio_code }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Responsables y Versión -->
            <div class="col-md-6 mb-4">
                <div class="card info-card">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">
                            <i class="bi bi-people text-primary"></i> Responsables
                        </h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-detail mb-0">
                            <tr>
                                <th>Responsable Solicitud:</th>
                                <td>
                                    {% if ticket.responsable_solicitud %}
                                        <strong>{{ ticket.responsable_solicitud }}</strong>
                                    {% else %}
                                        <span class="text-muted">No especificado</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Líder del Proyecto:</th>
                                <td>
                                    {% if ticket.lider_proyecto %}
                                        <strong>{{ ticket.lider_proyecto }}</strong>
                                    {% else %}
                                        <span class="text-muted">No especificado</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Número de Versión:</th>
                                <td>
                                    {% if ticket.numero_version %}
                                        <strong>v{{ ticket.numero_version }}</strong>
                                    {% else %}
                                        <span class="text-muted">No especificado</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Datos del Excel asociado -->
        {% if ticket.excel_data %}
        <div class="card info-card mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0">
                    <i class="bi bi-file-earmark-spreadsheet text-success"></i> Datos del Excel Asociado
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-detail mb-0">
                            <tr>
                                <th>ID del Excel:</th>
                                <td>{{ ticket.excel_data.id }}</td>
                            </tr>
                            <tr>
                                <th>Tipo de Pruebas:</th>
                                <td>{{ ticket.excel_data.tipo_pruebas|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th>Tipo de Aplicación:</th>
                                <td>{{ ticket.excel_data.tipo_aplicacion|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th>Fecha de Extracción:</th>
                                <td>{{ ticket.excel_data.extracted_date|date:"d/m/Y H:i:s" }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-detail mb-0">
                            <tr>
                                <th>Funcionalidad:</th>
                                <td>{{ ticket.excel_data.funcionalidad_liberacion|truncatewords:30|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th>Detalle de Cambios:</th>
                                <td>{{ ticket.excel_data.detalle_cambios|truncatewords:20|default:"-" }}</td>
                            </tr>
                            <tr>
                                <th>Justificación:</th>
                                <td>{{ ticket.excel_data.justificacion_cambio|truncatewords:20|default:"-" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Información adicional -->
        <div class="card info-card">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle text-primary"></i> Información del Sistema
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-detail mb-0">
                            <tr>
                                <th>ID del Ticket:</th>
                                <td>{{ ticket.id }}</td>
                            </tr>
                            <tr>
                                <th>Fecha de Creación:</th>
                                <td>{{ ticket.fecha_creacion|date:"d/m/Y H:i:s" }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-detail mb-0">
                            <tr>
                                <th>Última Actualización:</th>
                                <td>{{ ticket.fecha_actualizacion|date:"d/m/Y H:i:s" }}</td>
                            </tr>
                            <tr>
                                <th>Estado Actual:</th>
                                <td>
                                    <span class="badge bg-{% if ticket.estado == 'GENERADO' %}info
                                                       {% elif ticket.estado == 'EN_PROCESO' %}warning
                                                       {% elif ticket.estado == 'COMPLETADO' %}success
                                                       {% else %}danger{% endif %}">
                                        {{ ticket.get_estado_display }}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>