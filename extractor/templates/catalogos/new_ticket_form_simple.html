<!-- templates/catalogos/new_ticket_form_simple.html -->
{% extends 'extractor/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0"> Crear Nuevo Ticket Manual</h2>
                </div>
                <div class="card-body">
                    
                    <!-- MENSAJES DE ERROR CLAROS -->
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <!-- FORMULARIO SIMPLE -->
                    <form method="post" id="ticketFormSimple">
                        {% csrf_token %}
                        
                        <!-- CAMPOS BSICOS OBLIGATORIOS -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="cliente_simple" class="form-label fw-bold">Cliente *</label>
                                <select name="cliente" id="cliente_simple" class="form-select" required>
                                    <option value="">-- Seleccione un cliente --</option>
                                    {% for cliente in clientes %}
                                        <option value="{{ cliente.id }}">{{ cliente.nombre }} ({{ cliente.nomenclatura }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="tipo_servicio_simple" class="form-label fw-bold">Tipo de Servicio *</label>
                                <select name="tipo_servicio" id="tipo_servicio_simple" class="form-select" required>
                                    <option value="">-- Seleccione tipo --</option>
                                    {% for tipo in tipos_servicio %}
                                        <option value="{{ tipo.id }}">{{ tipo.nombre }} ({{ tipo.nomenclatura }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="proyecto_simple" class="form-label fw-bold">Proyecto *</label>
                                <select name="proyecto" id="proyecto_simple" class="form-select" required disabled>
                                    <option value="">-- Primero seleccione cliente --</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="consecutivo_simple" class="form-label">Consecutivo (opcional)</label>
                                <input type="number" 
                                       name="consecutivo" 
                                       id="consecutivo_simple" 
                                       class="form-control" 
                                       placeholder="Ej: 001" 
                                       min="1" 
                                       max="999">
                                <small class="text-muted">Dejar vac铆o para auto-generar</small>
                            </div>
                        </div>
                        
                        <!-- CAMPOS OPCIONALES -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="responsable_simple" class="form-label">Responsable</label>
                                <input type="text" name="responsable_solicitud" id="responsable_simple" 
                                       class="form-control" placeholder="Nombre del responsable">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="lider_simple" class="form-label">L铆der de Proyecto</label>
                                <input type="text" name="lider_proyecto" id="lider_simple" 
                                       class="form-control" placeholder="Nombre del l铆der">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="version_simple" class="form-label">N煤mero de Versi贸n</label>
                                <input type="text" name="numero_version" id="version_simple" 
                                       class="form-control" placeholder="Ej: 1.0">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="funcionalidad_simple" class="form-label">Funcionalidad de Liberaci贸n</label>
                                <textarea name="funcionalidad_liberacion" id="funcionalidad_simple" 
                                          class="form-control" rows="2" placeholder="Describa la funcionalidad..."></textarea>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="cambios_simple" class="form-label">Detalle de Cambios</label>
                                <textarea name="detalle_cambios" id="cambios_simple" 
                                          class="form-control" rows="2" placeholder="Describa los cambios..."></textarea>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="justificacion_simple" class="form-label">Justificaci贸n del Cambio</label>
                                <textarea name="justificacion_cambio" id="justificacion_simple" 
                                          class="form-control" rows="2" placeholder="Justifique el cambio..."></textarea>
                            </div>
                        </div>
                        
                        <!-- PREVIEW SIMPLE DEL CDIGO -->
                        <div class="alert alert-info">
                            <strong>C贸digo de ticket:</strong> 
                            <span id="codigo_preview_simple" class="font-monospace">BID-???-???-???-???-???-XXX</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-success btn-lg">
                                 Generar Ticket
                            </button>
                            <a href="{% url 'ticket_list' %}" class="btn btn-secondary btn-lg">
                                Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JAVASCRIPT SIMPLIFICADO -->
<script>
// Funci贸n para cargar proyectos
function cargarProyectos(clienteId, selectElement) {
    if (!clienteId) {
        selectElement.innerHTML = '<option value="">-- Primero seleccione cliente --</option>';
        selectElement.disabled = true;
        return;
    }
    
    selectElement.innerHTML = '<option value="">-- Cargando proyectos... --</option>';
    selectElement.disabled = true;
    
    fetch(`/catalogos/proyectos/por-cliente/${clienteId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            selectElement.innerHTML = '<option value="">-- Seleccione un proyecto --</option>';
            
            if (data.proyectos && data.proyectos.length > 0) {
                data.proyectos.forEach(proyecto => {
                    const option = document.createElement('option');
                    option.value = proyecto.id;
                    option.textContent = `${proyecto.nombre} (${proyecto.codigo})`;
                    option.dataset.codigo = proyecto.codigo;
                    selectElement.appendChild(option);
                });
                selectElement.disabled = false;
            } else {
                selectElement.innerHTML = '<option value="">-- No hay proyectos disponibles --</option>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            selectElement.innerHTML = '<option value="">-- Error al cargar proyectos --</option>';
        });
}

// Event listener para cliente
document.getElementById('cliente_simple').addEventListener('change', function() {
    const proyectoSelect = document.getElementById('proyecto_simple');
    cargarProyectos(this.value, proyectoSelect);
    actualizarPreview();
});

// Actualizar preview
function actualizarPreview() {
    const cliente = document.getElementById('cliente_simple');
    const proyecto = document.getElementById('proyecto_simple');
    const tipo = document.getElementById('tipo_servicio_simple');
    const consecutivo = document.getElementById('consecutivo_simple');
    
    let preview = 'BID-';
    
    // Tipo servicio
    if (tipo.selectedIndex > 0) {
        const tipoText = tipo.options[tipo.selectedIndex].text;
        const match = tipoText.match(/\(([^)]+)\)/);
        preview += (match ? match[1] : '???') + '-';
    } else {
        preview += '???-';
    }
    
    // Funci贸n (misma nomenclatura)
    if (tipo.selectedIndex > 0) {
        const tipoText = tipo.options[tipo.selectedIndex].text;
        const match = tipoText.match(/\(([^)]+)\)/);
        preview += (match ? match[1] : '???') + '-';
    } else {
        preview += '???-';
    }
    
    // Versi贸n (ID del tipo)
    if (tipo.value) {
        preview += tipo.value + '-';
    } else {
        preview += '???-';
    }
    
    // Cliente
    if (cliente.selectedIndex > 0) {
        const clienteText = cliente.options[cliente.selectedIndex].text;
        const match = clienteText.match(/\(([^)]+)\)/);
        preview += (match ? match[1] : '???') + '-';
    } else {
        preview += '???-';
    }
    
    // Proyecto
    if (proyecto.selectedIndex > 0 && !proyecto.disabled) {
        const option = proyecto.options[proyecto.selectedIndex];
        preview += (option.dataset.codigo || '???') + '-';
    } else {
        preview += '???-';
    }
    
    // Consecutivo
    if (consecutivo.value) {
        const cons = parseInt(consecutivo.value);
        if (!isNaN(cons) && cons >= 1 && cons <= 999) {
            preview += cons.toString().padStart(3, '0');
        } else {
            preview += '???';
        }
    } else {
        preview += 'XXX';
    }
    
    document.getElementById('codigo_preview_simple').textContent = preview;
}

// Agregar event listeners
document.getElementById('cliente_simple').addEventListener('change', actualizarPreview);
document.getElementById('proyecto_simple').addEventListener('change', actualizarPreview);
document.getElementById('tipo_servicio_simple').addEventListener('change', actualizarPreview);
document.getElementById('consecutivo_simple').addEventListener('input', actualizarPreview);

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    actualizarPreview();
});
</script>

<!-- Bootstrap CSS y JS (si no est谩n incluidos en base.html) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
    .card {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    .card-header {
        background-color: #007bff !important;
    }
    .form-label {
        font-weight: 600;
        color: #495057;
    }
    .font-monospace {
        font-family: 'Courier New', monospace;
        font-weight: bold;
    }
</style>
{% endblock %}