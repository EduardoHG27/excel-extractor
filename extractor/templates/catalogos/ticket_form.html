<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ titulo }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-{% if es_edicion %}pencil-square{% else %}plus-circle{% endif %}"></i>
                {{ titulo }}
            </h1>
            <a href="{% url 'tickets:ticket_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver a Tickets
            </a>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    <i class="bi bi-info-circle"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div class="card shadow-sm">
            <div class="card-body">
                <form method="post" id="ticketForm">
                    {% csrf_token %}
                    
                    <!-- Código generado (solo vista) -->
                    <div class="alert alert-info mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <strong><i class="bi bi-upc-scan"></i> Código Ticket:</strong>
                            </div>
                            <div class="col-md-10">
                                <span id="codigoPreview" class="fs-5 fw-bold font-monospace">
                                    {% if object.codigo %}
                                        {{ object.codigo }}
                                    {% else %}
                                        BID-----
                                    {% endif %}
                                </span>
                                <small class="text-muted ms-2">
                                    (Se generará automáticamente)
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Columna 1: Datos principales -->
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-building"></i> Cliente y Proyecto
                            </h5>
                            
                            <div class="mb-3">
                                <label for="id_cliente" class="form-label">Cliente *</label>
                                <select name="cliente" id="id_cliente" class="form-select" required>
                                    <option value="">Seleccione un cliente...</option>
                                    {% for cliente in clientes %}
                                        <option value="{{ cliente.id }}" 
                                                data-nomenclatura="{{ cliente.nomenclatura }}"
                                                {% if object.cliente_id == cliente.id %}selected{% endif %}>
                                            {{ cliente.nombre }} ({{ cliente.nomenclatura }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="id_proyecto" class="form-label">Proyecto</label>
                                <select name="proyecto" id="id_proyecto" class="form-select">
                                    <option value="">Seleccione un proyecto...</option>
                                    {% for proyecto in proyectos %}
                                        <option value="{{ proyecto.id }}" 
                                                data-cliente="{{ proyecto.cliente_id }}"
                                                data-nomenclatura="{{ proyecto.nomenclatura }}"
                                                {% if object.proyecto_id == proyecto.id %}selected{% endif %}>
                                            {{ proyecto.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="id_tipo_servicio" class="form-label">Tipo de Servicio</label>
                                <select name="tipo_servicio" id="id_tipo_servicio" class="form-select">
                                    <option value="">Seleccione tipo de servicio...</option>
                                    {% for tipo in tipos_servicio %}
                                        <option value="{{ tipo.id }}" 
                                                data-nomenclatura="{{ tipo.nomenclatura }}"
                                                {% if object.tipo_servicio_id == tipo.id %}selected{% endif %}>
                                            {{ tipo.nombre }} ({{ tipo.nomenclatura }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="id_excel_data" class="form-label">Datos de Excel (Opcional)</label>
                                <select name="excel_data" id="id_excel_data" class="form-select">
                                    <option value="">Sin datos de Excel...</option>
                                    {% for excel in excel_datas %}
                                        <option value="{{ excel.id }}" {% if object.excel_data_id == excel.id %}selected{% endif %}>
                                            {{ excel.extracted_date|date:"d/m/Y H:i" }} - {{ excel.cliente|default:"Sin cliente" }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Asocia este ticket a datos de Excel ya cargados</div>
                            </div>
                        </div>
                        
                        <!-- Columna 2: Códigos del ticket -->
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-upc-scan"></i> Componentes del Código
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="id_empresa_code" class="form-label">Empresa</label>
                                    <input type="text" class="form-control font-monospace" 
                                           id="id_empresa_code" name="empresa_code" 
                                           value="{{ object.empresa_code|default:'BID' }}" 
                                           maxlength="10" placeholder="BID">
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="id_tipo_servicio_code" class="form-label">Tipo Servicio</label>
                                    <input type="text" class="form-control font-monospace" 
                                           id="id_tipo_servicio_code" name="tipo_servicio_code" 
                                           value="{{ object.tipo_servicio_code|default:'' }}" 
                                           maxlength="10" placeholder="Ej: QA">
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="id_funcion_code" class="form-label">Función</label>
                                    <input type="text" class="form-control font-monospace" 
                                           id="id_funcion_code" name="funcion_code" 
                                           value="{{ object.funcion_code|default:'PRB' }}" 
                                           maxlength="20" placeholder="PRB">
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="id_version_code" class="form-label">Versión</label>
                                    <input type="text" class="form-control font-monospace" 
                                           id="id_version_code" name="version_code" 
                                           value="{{ object.version_code|default:'' }}" 
                                           maxlength="10" placeholder="V1">
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="id_cliente_code" class="form-label">Código Cliente</label>
                                    <input type="text" class="form-control font-monospace" 
                                           id="id_cliente_code" name="cliente_code" 
                                           value="{{ object.cliente_code|default:'' }}" 
                                           maxlength="10" placeholder="Ej: BID01">
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="id_proyecto_code" class="form-label">Código Proyecto</label>
                                    <input type="text" class="form-control font-monospace" 
                                           id="id_proyecto_code" name="proyecto_code" 
                                           value="{{ object.proyecto_code|default:'' }}" 
                                           maxlength="10" placeholder="Ej: B2C">
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="id_consecutivo" class="form-label">Consecutivo</label>
                                    <input type="number" class="form-control font-monospace" 
                                           id="id_consecutivo" name="consecutivo" 
                                           value="{{ object.consecutivo|default:siguiente_consecutivo }}" 
                                           min="1" max="999">
                                    <div class="form-text">Formato: 001, 002, etc.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <!-- Columna 3: Responsables -->
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-people"></i> Responsables
                            </h5>
                            
                            <div class="mb-3">
                                <label for="id_responsable_solicitud" class="form-label">Responsable de Solicitud</label>
                                <input type="text" class="form-control" id="id_responsable_solicitud" 
                                       name="responsable_solicitud" 
                                       value="{{ object.responsable_solicitud|default:'' }}" 
                                       placeholder="Nombre del responsable">
                            </div>
                            
                            <div class="mb-3">
                                <label for="id_lider_proyecto" class="form-label">Líder del Proyecto</label>
                                <input type="text" class="form-control" id="id_lider_proyecto" 
                                       name="lider_proyecto" 
                                       value="{{ object.lider_proyecto|default:'' }}" 
                                       placeholder="Nombre del líder">
                            </div>
                        </div>
                        
                        <!-- Columna 4: Estado y versión -->
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> Información Adicional
                            </h5>
                            
                            <div class="mb-3">
                                <label for="id_numero_version" class="form-label">Número de Versión</label>
                                <input type="text" class="form-control" id="id_numero_version" 
                                       name="numero_version" 
                                       value="{{ object.numero_version|default:'' }}" 
                                       placeholder="Ej: 1.0.0">
                            </div>
                            
                            <div class="mb-3">
                                <label for="id_estado" class="form-label">Estado</label>
                                <select name="estado" id="id_estado" class="form-select">
                                    <option value="GENERADO" {% if object.estado == 'GENERADO' or not object %}selected{% endif %}>Generado</option>
                                    <option value="EN_PROCESO" {% if object.estado == 'EN_PROCESO' %}selected{% endif %}>En Proceso</option>
                                    <option value="COMPLETADO" {% if object.estado == 'COMPLETADO' %}selected{% endif %}>Completado</option>
                                    <option value="CANCELADO" {% if object.estado == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-{% if es_edicion %}check-circle{% else %}plus-circle{% endif %}"></i>
                            {{ boton_accion }}
                        </button>
                        <a href="{% url 'tickets:ticket_list' %}" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Instrucciones -->
        <div class="card mt-4 bg-light">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-info-circle"></i> Formato del Código de Ticket
                </h5>
                <p class="card-text">
                    El código del ticket sigue el formato: 
                    <code class="fs-6 fw-bold">EMPRESA-TIPO_SERVICIO-FUNCIÓN-VERSIÓN-CLIENTE-PROYECTO-CONSECUTIVO</code>
                </p>
                <ul class="mb-0">
                    <li><strong>Empresa:</strong> Siempre BID (fijo)</li>
                    <li><strong>Tipo Servicio:</strong> Nomenclatura del tipo de servicio</li>
                    <li><strong>Función:</strong> PRB para pruebas (por defecto)</li>
                    <li><strong>Versión:</strong> Versión del software</li>
                    <li><strong>Cliente:</strong> Nomenclatura del cliente</li>
                    <li><strong>Proyecto:</strong> Nomenclatura del proyecto</li>
                    <li><strong>Consecutivo:</strong> Número secuencial de 3 dígitos</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Script para filtro dinámico de proyectos
        document.getElementById('id_cliente').addEventListener('change', function() {
            const clienteId = this.value;
            const proyectoSelect = document.getElementById('id_proyecto');
            const options = proyectoSelect.options;
            
            // Reset
            proyectoSelect.value = '';
            
            // Hide/show based on cliente
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                if (option.value) {
                    const optionCliente = option.getAttribute('data-cliente');
                    if (clienteId && optionCliente !== clienteId) {
                        option.style.display = 'none';
                    } else {
                        option.style.display = '';
                    }
                }
            }
        });
        
        // Script para autocompletar códigos basados en selecciones
        function autocompletarCodigos() {
            const clienteSelect = document.getElementById('id_cliente');
            const proyectoSelect = document.getElementById('id_proyecto');
            const tipoServicioSelect = document.getElementById('id_tipo_servicio');
            
            // Cliente code
            if (clienteSelect.value) {
                const clienteOption = clienteSelect.options[clienteSelect.selectedIndex];
                const nomenclatura = clienteOption.getAttribute('data-nomenclatura');
                if (nomenclatura) {
                    document.getElementById('id_cliente_code').value = nomenclatura;
                }
            }
            
            // Proyecto code
            if (proyectoSelect.value) {
                const proyectoOption = proyectoSelect.options[proyectoSelect.selectedIndex];
                const nomenclatura = proyectoOption.getAttribute('data-nomenclatura');
                if (nomenclatura) {
                    document.getElementById('id_proyecto_code').value = nomenclatura;
                }
            }
            
            // Tipo servicio code
            if (tipoServicioSelect.value) {
                const tipoOption = tipoServicioSelect.options[tipoServicioSelect.selectedIndex];
                const nomenclatura = tipoOption.getAttribute('data-nomenclatura');
                if (nomenclatura) {
                    document.getElementById('id_tipo_servicio_code').value = nomenclatura;
                }
            }
            
            actualizarCodigoPreview();
        }
        
        // Script para generar preview del código
        function actualizarCodigoPreview() {
            const empresa = document.getElementById('id_empresa_code').value || 'BID';
            const tipoServicio = document.getElementById('id_tipo_servicio_code').value || '---';
            const funcion = document.getElementById('id_funcion_code').value || '---';
            const version = document.getElementById('id_version_code').value || '---';
            const cliente = document.getElementById('id_cliente_code').value || '---';
            const proyecto = document.getElementById('id_proyecto_code').value || '---';
            const consecutivo = document.getElementById('id_consecutivo').value || '001';
            
            const codigo = `${empresa}-${tipoServicio}-${funcion}-${version}-${cliente}-${proyecto}-${String(consecutivo).padStart(3, '0')}`;
            document.getElementById('codigoPreview').textContent = codigo;
        }
        
        // Event listeners para autocompletar y preview
        document.addEventListener('DOMContentLoaded', function() {
            // Autocompletar cuando cambian selects
            document.getElementById('id_cliente').addEventListener('change', autocompletarCodigos);
            document.getElementById('id_proyecto').addEventListener('change', autocompletarCodigos);
            document.getElementById('id_tipo_servicio').addEventListener('change', autocompletarCodigos);
            
            // Preview en tiempo real
            document.querySelectorAll('#id_empresa_code, #id_tipo_servicio_code, #id_funcion_code, #id_version_code, #id_cliente_code, #id_proyecto_code, #id_consecutivo').forEach(input => {
                input.addEventListener('input', actualizarCodigoPreview);
            });
            
            // Trigger initial
            autocompletarCodigos();
            
            // Trigger change on cliente if exists
            const clienteSelect = document.getElementById('id_cliente');
            if (clienteSelect) {
                clienteSelect.dispatchEvent(new Event('change'));
            }
        });
    </script>
</body>
</html>