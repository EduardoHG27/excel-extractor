<!-- templates/catalogos/ticket_form.html -->
{% extends 'extractor/base.html' %}

{% block content %}
<div class="page-header">
    <h1>üé´ Crear Nuevo Ticket Manual</h1>
    <p class="text-muted">Complete los campos para generar un ticket personalizado</p>
</div>

<div class="row">
    <div class="col-md-8 col-md-offset-2">
        <div class="card">
            <div class="card-body">
                <form method="post" id="ticketForm">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label for="cliente">Cliente *</label>
                        <select name="cliente" id="cliente" class="form-control" required>
                            <option value="">-- Seleccione un cliente --</option>
                            {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nombre }} ({{ cliente.nomenclatura }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="proyecto">Proyecto *</label>
                        <select name="proyecto" id="proyecto" class="form-control" required disabled>
                            <option value="">-- Primero seleccione un cliente --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="tipo_servicio">Tipo de Servicio *</label>
                        <select name="tipo_servicio" id="tipo_servicio" class="form-control" required>
                            <option value="">-- Seleccione un tipo de servicio --</option>
                            {% for tipo in tipos_servicio %}
                                <option value="{{ tipo.id }}">{{ tipo.nombre }} ({{ tipo.nomenclatura }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- NUEVO: Campo para consecutivo manual -->
                    <div class="form-group" id="consecutivo-group">
                        <label for="consecutivo">
                            N√∫mero Consecutivo 
                            <span class="badge badge-info" style="background-color: #3498db; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px;">
                                Opcional - Dejar vac√≠o para auto-generar
                            </span>
                        </label>
                        <div class="consecutivo-input-group">
                            <span class="consecutivo-prefix" id="codigo-preview">BID-???-???-???-???-???-</span>
                            <input type="number" 
                                   name="consecutivo" 
                                   id="consecutivo" 
                                   class="form-control consecutivo-input" 
                                   placeholder="001" 
                                   min="1" 
                                   max="999"
                                   step="1">
                        </div>
                        <small class="form-text text-muted">
                            Ingrese un n√∫mero entre 1 y 999. El sistema verificar√° que no exista otro ticket con el mismo consecutivo para esta combinaci√≥n.
                            <br>√öltimo consecutivo usado: <strong>{{ ultimo_consecutivo|default:"0"|stringformat:"03d" }}</strong>
                        </small>
                        <div id="consecutivo-validacion" style="margin-top: 5px; font-size: 14px;"></div>
                    </div>

                    <hr>
                    <h4>Informaci√≥n Adicional</h4>
                    
                    <div class="form-group">
                        <label for="responsable_solicitud">Responsable de Solicitud</label>
                        <input type="text" name="responsable_solicitud" id="responsable_solicitud" 
                               class="form-control" placeholder="Nombre del responsable">
                    </div>

                    <div class="form-group">
                        <label for="lider_proyecto">L√≠der de Proyecto</label>
                        <input type="text" name="lider_proyecto" id="lider_proyecto" 
                               class="form-control" placeholder="Nombre del l√≠der">
                    </div>

                    <div class="form-group">
                        <label for="numero_version">N√∫mero de Versi√≥n</label>
                        <input type="text" name="numero_version" id="numero_version" 
                               class="form-control" placeholder="Ej: 1.0, 2.5, etc.">
                    </div>

                    <div class="form-group">
                        <label for="funcionalidad_liberacion">Funcionalidad de Liberaci√≥n</label>
                        <textarea name="funcionalidad_liberacion" id="funcionalidad_liberacion" 
                                  class="form-control" rows="3" placeholder="Describa la funcionalidad..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="detalle_cambios">Detalle de Cambios</label>
                        <textarea name="detalle_cambios" id="detalle_cambios" 
                                  class="form-control" rows="3" placeholder="Describa los cambios..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="justificacion_cambio">Justificaci√≥n del Cambio</label>
                        <textarea name="justificacion_cambio" id="justificacion_cambio" 
                                  class="form-control" rows="3" placeholder="Justifique el cambio..."></textarea>
                    </div>

                    <div class="form-group text-center">
                        <button type="submit" class="btn btn-success btn-lg">
                            üé´ Generar Ticket
                        </button>
                        <a href="{% url 'ticket_list' %}" class="btn btn-secondary btn-lg">
                            Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 25px;
        margin-top: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 4px;
        font-size: 16px;
        transition: border-color 0.3s;
    }
    
    .form-control:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
    }
    
    .consecutivo-input-group {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .consecutivo-prefix {
        background-color: #f8f9fa;
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 4px;
        font-family: monospace;
        font-size: 16px;
        color: #6c757d;
        min-width: 300px;
    }
    
    .consecutivo-input {
        max-width: 120px;
        text-align: center;
        font-family: monospace;
        font-size: 18px;
    }
    
    .btn-lg {
        padding: 12px 30px;
        font-size: 18px;
        margin: 0 10px;
    }
    
    hr {
        margin: 30px 0;
        border: 0;
        border-top: 2px solid #eee;
    }
    
    h4 {
        color: #2c3e50;
        margin-bottom: 20px;
    }
    
    .text-muted {
        color: #7f8c8d;
        font-size: 0.9em;
    }
    
    .text-center {
        text-align: center;
    }
    
    select[disabled] {
        background-color: #f8f9fa;
        cursor: not-allowed;
    }
    
    .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: normal;
    }
    
    #consecutivo-validacion {
        padding: 5px 10px;
        border-radius: 4px;
    }
    
    .validacion-exito {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
    }
    
    .validacion-error {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }
    
    .validacion-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
    }
</style>

<script>
    // Script para cargar proyectos din√°micamente seg√∫n el cliente seleccionado
    document.getElementById('cliente').addEventListener('change', function() {
        const clienteId = this.value;
        const proyectoSelect = document.getElementById('proyecto');
        
        // Resetear y deshabilitar el select de proyectos
        proyectoSelect.innerHTML = '<option value="">-- Cargando proyectos... --</option>';
        proyectoSelect.disabled = true;
        
        if (!clienteId) {
            proyectoSelect.innerHTML = '<option value="">-- Primero seleccione un cliente --</option>';
            return;
        }
        
        // Hacer la petici√≥n AJAX
        fetch(`/catalogos/proyectos/por-cliente/${clienteId}/`)
            .then(response => response.json())
            .then(data => {
                proyectoSelect.innerHTML = '<option value="">-- Seleccione un proyecto --</option>';
                
                if (data.proyectos && data.proyectos.length > 0) {
                    data.proyectos.forEach(proyecto => {
                        const option = document.createElement('option');
                        option.value = proyecto.id;
                        option.textContent = `${proyecto.nombre} (${proyecto.codigo})`;
                        option.dataset.codigo = proyecto.codigo;
                        proyectoSelect.appendChild(option);
                    });
                    proyectoSelect.disabled = false;
                } else {
                    proyectoSelect.innerHTML = '<option value="">-- No hay proyectos para este cliente --</option>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                proyectoSelect.innerHTML = '<option value="">-- Error al cargar proyectos --</option>';
            });
    });

    // NUEVO: Actualizar preview del c√≥digo de ticket
    function actualizarPreviewCodigo() {
        const clienteSelect = document.getElementById('cliente');
        const proyectoSelect = document.getElementById('proyecto');
        const tipoSelect = document.getElementById('tipo_servicio');
        const consecutivoInput = document.getElementById('consecutivo');
        
        let preview = 'BID-';
        
        // Tipo de servicio (nomenclatura)
        if (tipoSelect.selectedIndex > 0) {
            const tipoText = tipoSelect.options[tipoSelect.selectedIndex].text;
            const match = tipoText.match(/\(([^)]+)\)/);
            preview += (match ? match[1] : '???') + '-';
        } else {
            preview += '???-';
        }
        
        // Funci√≥n (misma nomenclatura)
        if (tipoSelect.selectedIndex > 0) {
            const tipoText = tipoSelect.options[tipoSelect.selectedIndex].text;
            const match = tipoText.match(/\(([^)]+)\)/);
            preview += (match ? match[1] : '???') + '-';
        } else {
            preview += '???-';
        }
        
        // Versi√≥n (ID del tipo)
        if (tipoSelect.value) {
            preview += tipoSelect.value + '-';
        } else {
            preview += '???-';
        }
        
        // Cliente (nomenclatura)
        if (clienteSelect.selectedIndex > 0) {
            const clienteText = clienteSelect.options[clienteSelect.selectedIndex].text;
            const match = clienteText.match(/\(([^)]+)\)/);
            preview += (match ? match[1] : '???') + '-';
        } else {
            preview += '???-';
        }
        
        // Proyecto (c√≥digo)
        if (proyectoSelect.selectedIndex > 0 && !proyectoSelect.disabled) {
            const selectedOption = proyectoSelect.options[proyectoSelect.selectedIndex];
            preview += (selectedOption.dataset.codigo || '???') + '-';
        } else {
            preview += '???-';
        }
        
        // Consecutivo
        if (consecutivoInput.value) {
            const cons = parseInt(consecutivoInput.value);
            if (!isNaN(cons) && cons >= 1 && cons <= 999) {
                preview += cons.toString().padStart(3, '0');
            } else {
                preview += '???';
            }
        } else {
            preview += 'XXX';  // Indicador de auto-generado
        }
        
        document.querySelector('.consecutivo-prefix').textContent = preview;
    }

    // Agregar event listeners para actualizar el preview
    document.getElementById('cliente').addEventListener('change', actualizarPreviewCodigo);
    document.getElementById('proyecto').addEventListener('change', actualizarPreviewCodigo);
    document.getElementById('tipo_servicio').addEventListener('change', actualizarPreviewCodigo);
    document.getElementById('consecutivo').addEventListener('input', actualizarPreviewCodigo);
    
    // NUEVO: Validar consecutivo en tiempo real
    document.getElementById('consecutivo').addEventListener('input', function() {
        const consecutivo = this.value;
        const validacionDiv = document.getElementById('consecutivo-validacion');
        const clienteSelect = document.getElementById('cliente');
        const proyectoSelect = document.getElementById('proyecto');
        const tipoSelect = document.getElementById('tipo_servicio');
        
        if (!consecutivo) {
            validacionDiv.innerHTML = 'üî¢ Consecutivo auto-generado autom√°ticamente';
            validacionDiv.className = 'validacion-info';
            return;
        }
        
        const consNum = parseInt(consecutivo);
        if (isNaN(consNum) || consNum < 1 || consNum > 999) {
            validacionDiv.innerHTML = '‚ùå El consecutivo debe ser un n√∫mero entre 1 y 999';
            validacionDiv.className = 'validacion-error';
            return;
        }
        
        // Validar que todos los campos necesarios est√©n seleccionados
        if (!clienteSelect.value || !proyectoSelect.value || !tipoSelect.value) {
            validacionDiv.innerHTML = '‚ö†Ô∏è Seleccione cliente, proyecto y tipo de servicio para verificar disponibilidad';
            validacionDiv.className = 'validacion-info';
            return;
        }
        
        // Aqu√≠ podr√≠as hacer una validaci√≥n AJAX para verificar si el consecutivo ya existe
        // Por ahora, solo mostramos un mensaje
        validacionDiv.innerHTML = `‚úÖ Consecutivo ${consNum.toString().padStart(3, '0')} disponible (se verificar√° al guardar)`;
        validacionDiv.className = 'validacion-exito';
    });

    // Inicializar preview cuando se carga la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        actualizarPreviewCodigo();
    });
</script>
{% endblock %}