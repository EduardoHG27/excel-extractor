<!-- templates/extractor/ticket_detail.html -->
{% extends 'extractor/base.html' %}

{% block content %}
<div class="page-header">
    <h1>üé´ Detalle del Ticket</h1>
    <p>C√≥digo: <strong>{{ ticket.codigo }}</strong></p>
</div>

<div style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">
    <a href="{% url 'tickets_list' %}" class="btn" style="padding: 8px 16px;">
        ‚Üê Volver a lista
    </a>
    
    <!-- Bot√≥n para cambiar estado -->
    <div style="margin-left: auto;">
        <form method="post" action="{% url 'ticket_cambiar_estado' ticket.id %}" style="display: inline;">
            {% csrf_token %}
            <select name="nuevo_estado" onchange="this.form.submit()" 
                    style="padding: 8px 12px; border-radius: 4px;">
                {% for estado_codigo, estado_nombre in estados %}
                <option value="{{ estado_codigo }}" 
                        {% if ticket.estado == estado_codigo %}selected{% endif %}>
                    {{ estado_nombre }}
                </option>
                {% endfor %}
            </select>
        </form>
    </div>
</div>

<!-- Resumen del Ticket -->
<div style="background-color: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <h2 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
        Informaci√≥n del Ticket
    </h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <!-- C√≥digo del Ticket -->
        <div>
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <h3 style="color: #3498db; margin-bottom: 10px;">C√≥digo del Ticket</h3>
                <div style="font-family: 'Courier New', monospace; font-size: 1.3rem; font-weight: bold; 
                            background-color: white; padding: 15px; border-radius: 4px; text-align: center;
                            border: 2px solid #3498db;">
                    {{ ticket.codigo }}
                </div>
                <button onclick="copiarTicket('{{ ticket.codigo }}')" 
                        style="margin-top: 10px; padding: 8px 16px; background-color: #3498db; 
                               color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                    üìã Copiar C√≥digo
                </button>
            </div>
        </div>
        
        <!-- Estado y Fechas -->
        <div>
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <h3 style="color: #e74c3c; margin-bottom: 10px;">Estado y Fechas</h3>
                <div style="display: grid; gap: 10px;">
                    <div>
                        <strong>Estado:</strong>
                        <span style="display: inline-block; padding: 5px 12px; border-radius: 15px; 
                                     {% if ticket.estado == 'GENERADO' %}background-color: #d4edda; color: #155724;
                                     {% elif ticket.estado == 'EN_PROCESO' %}background-color: #fff3cd; color: #856404;
                                     {% elif ticket.estado == 'COMPLETADO' %}background-color: #d1ecf1; color: #0c5460;
                                     {% else %}background-color: #f8d7da; color: #721c24;{% endif %}">
                            {{ ticket.get_estado_display }}
                        </span>
                    </div>
                    <div>
                        <strong>Creado:</strong> {{ ticket.fecha_creacion|date:"d/m/Y H:i" }}
                    </div>
                    <div>
                        <strong>√öltima Actualizaci√≥n:</strong> {{ ticket.fecha_actualizacion|date:"d/m/Y H:i" }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Desglose del C√≥digo -->
<div style="background-color: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <h2 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
        üîç Desglose del C√≥digo
    </h2>
    
    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; margin-bottom: 20px;">
        {% for clave, valor in partes_ticket.items %}
        <div style="text-align: center;">
            <div style="background-color: 
                {% cycle '#e74c3c' '#3498db' '#2ecc71' '#f39c12' '#9b59b6' '#1abc9c' '#34495e' %}; 
                color: white; padding: 10px 15px; border-radius: 5px; font-weight: bold; min-width: 80px;">
                {{ valor }}
            </div>
            <div style="font-size: 0.8rem; margin-top: 5px; text-transform: capitalize;">
                {{ clave }}
            </div>
        </div>
        {% if not forloop.last %}
        <div style="font-size: 1.5rem; color: #7f8c8d; margin: 0 5px;">-</div>
        {% endif %}
        {% endfor %}
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
            <strong>Empresa:</strong> {{ partes_ticket.empresa }}
        </div>
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
            <strong>Tipo de Servicio:</strong> {{ partes_ticket.tipo_servicio }}
        </div>
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
            <strong>Funci√≥n/√Årea:</strong> {{ partes_ticket.funcion }}
        </div>
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
            <strong>Versi√≥n:</strong> {{ partes_ticket.version }}
        </div>
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
            <strong>Cliente:</strong> {{ partes_ticket.cliente }}
        </div>
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
            <strong>Proyecto:</strong> {{ partes_ticket.proyecto }}
        </div>
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
            <strong>Consecutivo:</strong> {{ partes_ticket.consecutivo }}
        </div>
    </div>
</div>

<!-- Informaci√≥n Relacionada -->
<div style="background-color: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <h2 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
        üìä Informaci√≥n Relacionada
    </h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <!-- Informaci√≥n del Cliente -->
        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 5px; border-left: 4px solid #3498db;">
            <h3 style="color: #2c3e50; margin-bottom: 15px;">üë§ Cliente</h3>
            {% if ticket.cliente %}
            <div>
                <strong>Nombre:</strong> {{ ticket.cliente.nombre }}
            </div>
            <div>
                <strong>Nomenclatura:</strong> {{ ticket.cliente.nomenclatura }}
            </div>
            <div>
                <strong>Estado:</strong> 
                <span style="color: {% if ticket.cliente.activo %}#27ae60{% else %}#e74c3c{% endif %};">
                    {{ ticket.cliente.activo|yesno:"Activo,Inactivo" }}
                </span>
            </div>
            {% else %}
            <div style="color: #7f8c8d;">
                <i>Cliente no encontrado en cat√°logo</i>
            </div>
            <div>
                <strong>C√≥digo en ticket:</strong> {{ ticket.cliente_code }}
            </div>
            {% endif %}
        </div>
        
        <!-- Informaci√≥n del Proyecto -->
        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 5px; border-left: 4px solid #2ecc71;">
            <h3 style="color: #2c3e50; margin-bottom: 15px;">üìÅ Proyecto</h3>
            {% if ticket.proyecto %}
            <div>
                <strong>Nombre:</strong> {{ ticket.proyecto.nombre }}
            </div>
            <div>
                <strong>C√≥digo:</strong> {{ ticket.proyecto.codigo }}
            </div>
            <div>
                <strong>Cliente:</strong> {{ ticket.proyecto.cliente.nombre }}
            </div>
            <div>
                <strong>Estado:</strong> 
                <span style="color: {% if ticket.proyecto.activo %}#27ae60{% else %}#e74c3c{% endif %};">
                    {{ ticket.proyecto.activo|yesno:"Activo,Inactivo" }}
                </span>
            </div>
            {% else %}
            <div style="color: #7f8c8d;">
                <i>Proyecto no encontrado en cat√°logo</i>
            </div>
            <div>
                <strong>C√≥digo en ticket:</strong> {{ ticket.proyecto_code }}
            </div>
            {% endif %}
        </div>
        
        <!-- Informaci√≥n del Tipo de Servicio -->
        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 5px; border-left: 4px solid #f39c12;">
            <h3 style="color: #2c3e50; margin-bottom: 15px;">‚öôÔ∏è Tipo de Servicio</h3>
            {% if ticket.tipo_servicio %}
            <div>
                <strong>Nombre:</strong> {{ ticket.tipo_servicio.nombre }}
            </div>
            <div>
                <strong>Nomenclatura:</strong> {{ ticket.tipo_servicio.nomenclatura }}
            </div>
            <div>
                <strong>Estado:</strong> 
                <span style="color: {% if ticket.tipo_servicio.activo %}#27ae60{% else %}#e74c3c{% endif %};">
                    {{ ticket.tipo_servicio.activo|yesno:"Activo,Inactivo" }}
                </span>
            </div>
            {% else %}
            <div style="color: #7f8c8d;">
                <i>Tipo de servicio no encontrado</i>
            </div>
            <div>
                <strong>C√≥digo en ticket:</strong> {{ ticket.tipo_servicio_code }}
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if datos_excel %}
<!-- Datos Originales del Excel -->
<div style="background-color: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <h2 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
        üìã Datos Originales del Excel
    </h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
        {% for clave, valor in datos_excel.items %}
        {% if valor %}
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
            <strong>{{ clave|title|replace:"_, " }}:</strong>
            <div style="margin-top: 5px; word-break: break-word;">
                {% if clave in 'funcionalidad_liberacion,detalle_cambios,justificacion_cambio' %}
                    {{ valor|linebreaks }}
                {% else %}
                    {{ valor|default:"N/A" }}
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    
    <div style="margin-top: 20px; color: #7f8c8d; font-size: 0.9rem;">
        <strong>Extra√≠do el:</strong> {{ datos_excel.extracted_date|date:"d/m/Y H:i" }}
    </div>
</div>
{% endif %}

<!-- Botones de Acci√≥n -->
<div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 30px;">
    <button onclick="imprimirTicket()" class="btn" style="padding: 10px 20px; background-color: #3498db; color: white;">
        üñ®Ô∏è Imprimir Ticket
    </button>
    <button onclick="descargarPDF()" class="btn" style="padding: 10px 20px; background-color: #e74c3c; color: white;">
        üìÑ Descargar PDF
    </button>
    <button onclick="enviarPorEmail()" class="btn" style="padding: 10px 20px; background-color: #2ecc71; color: white;">
        üìß Enviar por Email
    </button>
    <a href="{% url 'upload_excel' %}" class="btn" style="padding: 10px 20px; background-color: #9b59b6; color: white; text-decoration: none;">
        üì§ Generar Nuevo Ticket
    </a>
</div>

<script>
    function copiarTicket(codigo) {
        navigator.clipboard.writeText(codigo)
            .then(() => {
                alert('Ticket copiado: ' + codigo);
            })
            .catch(err => {
                console.error('Error al copiar: ', err);
                alert('Error al copiar el ticket');
            });
    }
    
    function imprimirTicket() {
        window.print();
    }
    
    function descargarPDF() {
        alert('Funci√≥n de descarga de PDF. Implementa la l√≥gica necesaria aqu√≠.');
    }
    
    function enviarPorEmail() {
        const ticketCodigo = '{{ ticket.codigo }}';
        const subject = encodeURIComponent(`Ticket ${ticketCodigo} - Sistema de Gesti√≥n`);
        const body = encodeURIComponent(`Hola,\n\nTe env√≠o el ticket generado:\n\nC√≥digo: ${ticketCodigo}\nFecha: {{ ticket.fecha_creacion|date:"d/m/Y" }}\nCliente: {% if ticket.cliente %}{{ ticket.cliente.nombre }}{% else %}{{ ticket.cliente_code }}{% endif %}\nProyecto: {% if ticket.proyecto %}{{ ticket.proyecto.nombre }}{% else %}{{ ticket.proyecto_code }}{% endif %}\n\nSaludos.`);
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }
</script>

<style>
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 0.9rem;
    }
    
    @media print {
        .btn, form {
            display: none !important;
        }
        
        .page-header, h1, h2, h3 {
            color: black !important;
        }
    }
</style>
{% endblock %}